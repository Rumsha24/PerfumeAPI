@model PerfumeAPI.Models.Entities.Product
@using Microsoft.AspNetCore.Identity
@inject UserManager<PerfumeAPI.Models.Entities.User> UserManager

@{
    ViewData["Title"] = Model.Name;
    var avgRating = Model.Comments?.Any() == true ? Model.Comments.Average(c => c.Rating) : 0;
    var reviewCount = Model.Comments?.Count ?? 0;
}

<div class="container my-5">
    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mb-4">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Product Images -->
        <div class="col-lg-6">
            <div class="product-image-container position-relative">
                <img src="@(Model.ImageUrl ?? "/images/default-perfume.jpg")"
                     class="img-fluid rounded-3 main-product-image"
                     alt="@Model.Name"
                     onerror="this.onerror=null;this.src='/images/default-perfume.jpg';">

                @if (Model.IsFeatured)
                {
                    <span class="position-absolute top-0 start-0 badge bg-danger mt-3 ms-3">
                        <i class="fas fa-crown me-1"></i> Featured
                    </span>
                }
                @if (Model.StockQuantity <= 5 && Model.StockQuantity > 0)
                {
                    <span class="position-absolute top-0 end-0 badge bg-warning text-dark mt-3 me-3">
                        <i class="fas fa-exclamation-circle me-1"></i> Only @Model.StockQuantity left
                    </span>
                }
            </div>

            <!-- Thumbnails -->
            <div class="thumbnails mt-3 d-flex flex-wrap gap-2">
                <div class="thumbnail-item border rounded-2 p-1">
                    <img src="@(Model.ImageUrl ?? "/images/default-perfume.jpg")"
                         class="img-thumbnail cursor-pointer"
                         style="width:80px;height:80px;object-fit:cover;"
                         alt="@Model.Name"
                         onclick="changeMainImage(this.src)">
                </div>
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-lg-6">
            <div class="product-details">
                <h1 class="mb-2">@Model.Name</h1>
                <p class="text-muted mb-3">
                    <i class="fas fa-tag me-1"></i> @Model.FragranceType
                    @if (!string.IsNullOrEmpty(Model.FragranceFamily))
                    {
                        <span> | @Model.FragranceFamily</span>
                    }
                    | <i class="fas fa-weight-hanging me-1"></i> @Model.Size
                </p>

                <!-- Rating -->
                <div class="rating mb-3 d-flex align-items-center">
                    <div class="stars me-2">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <i class="@(i <= Math.Round(avgRating) ? "fas text-warning" : "far text-secondary") fa-star"></i>
                        }
                    </div>
                    <span class="text-muted">(@reviewCount review@(reviewCount == 1 ? "" : "s"))</span>
                    <a href="#reviews" class="ms-2 small">See all reviews</a>
                </div>

                <!-- Price -->
                <div class="price-section mb-4">
                    <h3 class="text-primary mb-1">@Model.Price.ToString("C")</h3>
                    <p class="text-muted small mb-2">
                        <i class="fas fa-shipping-fast me-1"></i>
                        @if (Model.ShippingCost == 0)
                        {
                            <span class="text-success">Free shipping</span>
                        }
                        else
                        {
                            <span>+ @Model.ShippingCost.ToString("C") shipping</span>
                        }
                    </p>
                </div>

                <!-- Stock Status -->
                <div class="stock-status mb-4">
                    @if (Model.StockQuantity > 0)
                    {
                        <p class="text-success">
                            <i class="fas fa-check-circle me-1"></i> In Stock (@Model.StockQuantity available)
                        </p>
                    }
                    else
                    {
                        <p class="text-danger">
                            <i class="fas fa-times-circle me-1"></i> Currently Out of Stock
                        </p>
                    }
                </div>

                <!-- Add to Cart -->
                @if (Model.StockQuantity > 0)
                {
                    <form method="post" asp-controller="Cart" asp-action="AddToCart" class="mb-4">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="productId" value="@Model.Id">
                        <div class="input-group mb-3" style="max-width: 200px;">
                            <button class="btn btn-outline-secondary decrement" type="button">-</button>
                            <input type="number" name="quantity" value="1" min="1" max="@Model.StockQuantity"
                                   class="form-control text-center quantity">
                            <button class="btn btn-outline-secondary increment" type="button">+</button>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-cart-plus me-2"></i> Add to Cart
                        </button>
                    </form>

                    <form asp-controller="Order" asp-action="CheckoutSingleItem" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="productId" value="@Model.Id">
                        <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-bolt me-2"></i> Buy Now
                        </button>
                    </form>
                }
                else
                {
                    <button class="btn btn-secondary w-100" disabled>
                        <i class="fas fa-times-circle me-2"></i> Out of Stock
                    </button>
                }

                <!-- Admin Actions -->
                @if (User.IsInRole("Admin"))
                {
                    <div class="admin-actions mt-4 border-top pt-3">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-warning me-2">
                            <i class="fas fa-edit me-1"></i> Edit Product
                        </a>
                        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger">
                            <i class="fas fa-trash-alt me-1"></i> Delete
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Product Tabs -->
    <div class="product-tabs mt-5">
        <ul class="nav nav-tabs" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">
                    <i class="fas fa-file-alt me-2"></i>Description
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                    <i class="fas fa-info-circle me-2"></i>Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                    <i class="fas fa-star me-2"></i>Reviews (@reviewCount)
                </button>
            </li>
        </ul>

        <div class="tab-content p-4 border border-top-0 rounded-bottom" id="productTabsContent">
            <!-- Description Tab -->
            <div class="tab-pane fade show active" id="description" role="tabpanel">
                <h4 class="mb-3">About This Fragrance</h4>
                <p class="lead">@Model.Description</p>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5><i class="fas fa-spa me-2 text-primary"></i>Fragrance Notes</h5>
                        <ul class="list-unstyled">
                            <li class="mb-2"><strong>Top Notes:</strong> Bergamot, Lemon, Green Notes</li>
                            <li class="mb-2"><strong>Middle Notes:</strong> Jasmine, Rose, Lily of the Valley</li>
                            <li class="mb-2"><strong>Base Notes:</strong> Sandalwood, Musk, Amber</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-flask me-2 text-primary"></i>Technical Details</h5>
                        <ul class="list-unstyled">
                            <li class="mb-2"><strong>Size:</strong> @Model.Size</li>
                            <li class="mb-2"><strong>Fragrance Type:</strong> @Model.FragranceType</li>
                            <li class="mb-2"><strong>Longevity:</strong> 6-8 hours</li>
                            <li class="mb-2"><strong>Sillage:</strong> Moderate</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Details Tab -->
            <div class="tab-pane fade" id="details" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="mb-3">Product Specifications</h4>
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th scope="row">Brand</th>
                                    <td>Your Brand Name</td>
                                </tr>
                                <tr>
                                    <th scope="row">Fragrance Family</th>
                                    <td>@(Model.FragranceFamily ?? "Not specified")</td>
                                </tr>
                                <tr>
                                    <th scope="row">Concentration</th>
                                    <td>Eau de Parfum</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4 class="mb-3">Shipping & Returns</h4>
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-shipping-fast text-primary me-2"></i>Delivery</h5>
                                <p class="card-text">
                                    Ships within 1-2 business days<br>
                                    Free shipping on orders over $50
                                </p>
                                <h5 class="card-title mt-3"><i class="fas fa-undo text-primary me-2"></i>Returns</h5>
                                <p class="card-text">
                                    30-day return policy<br>
                                    Free returns for unopened items
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div class="tab-pane fade" id="reviews" role="tabpanel">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-pen me-2"></i>Write a Review</h5>
                        </div>
                        <div class="card-body">
                            <form asp-action="AddComment" asp-controller="Product" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="productId" value="@Model.Id">
                                <div class="mb-3">
                                    <label class="form-label">Your Rating</label>
                                    <div class="rating-input">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="far fa-star text-warning" data-rating="@i" style="cursor: pointer; font-size: 1.5rem;"></i>
                                        }
                                        <input type="hidden" name="rating" id="selectedRating" value="5">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Your Review</label>
                                    <textarea name="text" class="form-control" rows="4" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i> Submit Review
                                </button>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <a href="/Account/Login?returnUrl=@Context.Request.Path" class="alert-link">Sign in</a> to leave a review.
                    </div>
                }

                <h4 class="mb-4">Customer Reviews</h4>

                @if (Model.Comments?.Any() == true)
                {
                    foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                    {
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <div>
                                        <h5 class="card-title mb-1">@comment.User?.UserName</h5>
                                        <small class="text-muted">@comment.CreatedAt.ToString("MMMM dd, yyyy")</small>
                                    </div>
                                    <div class="text-warning">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="@(i <= comment.Rating ? "fas" : "far") fa-star"></i>
                                        }
                                    </div>
                                </div>
                                <p class="card-text mt-3">@comment.Text</p>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> No reviews yet. Be the first to review!
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Quantity controls
            $('.increment').click(function () {
                const $input = $(this).siblings('.quantity');
                let value = parseInt($input.val()) || 1;
                const max = parseInt($input.attr('max')) || 100;
                if (value < max) {
                    $input.val(value + 1);
                }
            });

            $('.decrement').click(function () {
                const $input = $(this).siblings('.quantity');
                let value = parseInt($input.val()) || 1;
                if (value > 1) {
                    $input.val(value - 1);
                }
            });

            // Rating stars
            $('.rating-input i').hover(function () {
                const rating = $(this).data('rating');
                $(this).prevAll().addBack().removeClass('far').addClass('fas');
                $(this).nextAll().removeClass('fas').addClass('far');
            });

            $('.rating-input i').click(function () {
                const rating = $(this).data('rating');
                $(this).prevAll().addBack().removeClass('far').addClass('fas');
                $(this).nextAll().removeClass('fas').addClass('far');
                $('#selectedRating').val(rating);
            });

            // Change main image
            function changeMainImage(src) {
                $('.main-product-image').attr('src', src);
            }
        });
    </script>

    <style>
        .product-image-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-product-image {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .thumbnail-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .thumbnail-item:hover {
                border-color: #0d6efd !important;
            }

        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background-color: #f8f9fa;
            border-color: #dee2e6 #dee2e6 #f8f9fa;
        }
    </style>
}